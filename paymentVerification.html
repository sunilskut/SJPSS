<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Verification Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <style>
        .theme-all {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .theme-single {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .hover-lift {
            transition: all 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-2px);
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        /* Reduced font sizes globally */
        body { font-size: 14px; }
        h1 { font-size: 1.75rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.25rem; }
        .text-lg { font-size: 1rem; }
        .text-xl { font-size: 1.125rem; }
        .text-2xl { font-size: 1.375rem; }
        .text-3xl { font-size: 1.75rem; }
        .text-4xl { font-size: 2rem; }
    </style>
</head>
<body class="min-h-screen p-3 sm:p-4 lg:p-6 theme-all">
    <div class="max-w-full mx-auto">
        <!-- Header -->
        <div id="headerCard" class="gradient-card rounded-2xl shadow-2xl mb-6 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-800 to-slate-600 px-6 py-4 sm:px-8 sm:py-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <h1 id="headerTitle" class="font-bold text-white mb-2">
                            Payment Verification Dashboard
                        </h1>
                        <p id="headerSubtitle" class="text-slate-200">
                            Manage pending UPI payments efficiently
                        </p>
                    </div>
                    <div class="mt-3 sm:mt-0">
                        <button onclick="showAllOrders()" 
                                class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-xl transition-all duration-300 backdrop-blur-sm border border-white/20 text-sm">
                            <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            Show All Orders
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="gradient-card rounded-2xl shadow-xl p-8 text-center">
            <div class="w-12 h-12 border-4 border-slate-200 border-t-blue-500 rounded-full animate-spin-custom mx-auto mb-4"></div>
            <p class="text-slate-600 mb-2">Loading pending payments...</p>
            <p class="text-slate-500 text-sm">Please wait while we fetch the data</p>
        </div>

        <!-- Error State -->
        <div id="error" class="gradient-card rounded-2xl shadow-xl p-6 hidden">
            <div class="bg-red-50 border border-red-200 rounded-xl p-4">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-red-500 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <h3 class="text-red-800 font-semibold mb-2">Error loading payments</h3>
                        <div id="errorMessage" class="text-red-700 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div id="tableContainer" class="gradient-card rounded-2xl shadow-2xl overflow-hidden hidden fade-in">
            <div class="p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <div>
                        <h2 id="tableTitle" class="font-bold text-slate-800 mb-1">Payment Verification Queue</h2>
                        <p id="tableSubtitle" class="text-slate-600 text-sm"></p>
                    </div>
                    <div class="mt-3 sm:mt-0 flex space-x-2">
                        <span id="recordCount" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium"></span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gradient-to-r from-slate-700 to-slate-600 text-white">
                                <th class="px-3 py-3 text-left text-xs font-semibold rounded-tl-xl">S.No</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold">Order ID</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold">Customer</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold">Date & Time</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold">Amount</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold">Txn ID</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold">UPI Note</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold rounded-tr-xl">Action</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody" class="divide-y divide-slate-100">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- No Data State -->
        <div id="noData" class="gradient-card rounded-2xl shadow-xl p-8 text-center hidden">
            <div class="text-5xl mb-4">ðŸ“‹</div>
            <h3 class="font-bold text-slate-800 mb-3">No Pending Payments</h3>
            <p class="text-slate-600 mb-4">All UPI payments have been processed!</p>
            <button onclick="loadPendingPayments()" 
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition-colors duration-300 text-sm">
                Refresh Data
            </button>
        </div>
    </div>

    <!-- Popup for address -->
    <div id="popup" class="absolute bg-slate-800 text-white px-3 py-2 rounded-lg shadow-xl text-xs max-w-sm z-50 opacity-0 pointer-events-none transition-all duration-300 transform translate-y-2">
        <div class="absolute top-0 left-6 w-0 h-0 border-l-4 border-r-4 border-b-4 border-transparent border-b-slate-800 transform -translate-y-full"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB3iBWleWNMCdQS9F0HR1wHBBtHkeMawhg",
            authDomain: "sjpss-f504b.firebaseapp.com",
            projectId: "sjpss-f504b",
            storageBucket: "sjpss-f504b.firebasestorage.app",
            messagingSenderId: "227402980311",
            appId: "1:227402980311:web:56b580456ab6b9c6758992",
            measurementId: "G-LZ4YP9YPN6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DOM elements
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const tableContainer = document.getElementById('tableContainer');
        const noData = document.getElementById('noData');
        const tableBody = document.getElementById('paymentsTableBody');
        const popup = document.getElementById('popup');
        const headerTitle = document.getElementById('headerTitle');
        const headerSubtitle = document.getElementById('headerSubtitle');
        const tableTitle = document.getElementById('tableTitle');
        const tableSubtitle = document.getElementById('tableSubtitle');
        const recordCount = document.getElementById('recordCount');

        let orders = [];
        let currentOrderId = null;

        // Get URL parameters
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                orderId: params.get('orderId')
            };
        }

        // Update theme based on filter
        function updateTheme(orderId) {
            const body = document.body;
            const headerCard = document.getElementById('headerCard');
            
            if (orderId) {
                body.className = body.className.replace('theme-all', 'theme-single');
                headerTitle.textContent = `Order Details - ${orderId}`;
                headerSubtitle.textContent = 'Specific order payment verification';
                tableTitle.textContent = 'Order Payment Details';
            } else {
                body.className = body.className.replace('theme-single', 'theme-all');
                headerTitle.textContent = 'Payment Verification Dashboard';
                headerSubtitle.textContent = 'Manage pending UPI payments efficiently';
                tableTitle.textContent = 'Payment Verification Queue';
            }
        }

        // Show all orders
        function showAllOrders() {
            window.history.pushState({}, '', window.location.pathname);
            currentOrderId = null;
            updateTheme(null);
            loadPendingPayments();
        }

        // Load pending payments
        async function loadPendingPayments() {
            try {
                const params = getURLParams();
                currentOrderId = params.orderId;
                updateTheme(currentOrderId);

                loading.style.display = 'block';
                error.style.display = 'none';
                tableContainer.style.display = 'none';
                noData.style.display = 'none';

                let snapshot;
                
                if (currentOrderId) {
                    // Query for specific order
                    snapshot = await db.collection('orders')
                        .where(firebase.firestore.FieldPath.documentId(), '==', currentOrderId)
                        .get();
                } else {
                    // Query for all pending payments
                    try {
                        snapshot = await db.collection('orders')
                            .where('paymentStatus', '==', 'paid')
                            .where('paymentMethod', '==', 'UPI')
                            .orderBy('createdAt', 'desc')
                            .get();
                    } catch (indexError) {
                        console.log('Composite index not available, using alternative query...');
                        snapshot = await db.collection('orders')
                            .where('paymentStatus', '==', 'paid')
                            .where('paymentMethod', '==', 'UPI')
                            .get();
                    }
                }

                orders = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    orders.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Sort by createdAt
                orders.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                    return dateA - dateB;
                });

                loading.style.display = 'none';
                
                if (orders.length === 0) {
                    noData.style.display = 'block';
                    if (currentOrderId) {
                        document.querySelector('#noData h3').textContent = 'Order Not Found';
                        document.querySelector('#noData p').textContent = `Order ${currentOrderId} was not found or doesn't match the criteria.`;
                    }
                } else {
                    displayPayments();
                    tableContainer.style.display = 'block';
                }
            } catch (err) {
                console.error('Error loading payments:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                errorMessage.innerHTML = `
                    <strong>Error:</strong> ${err.message}<br><br>
                    <strong>Solution:</strong> You may need to create a composite index in Firestore.<br>
                    <a href="https://console.firebase.google.com/v1/r/project/sjpss-f504b/firestore/indexes" 
                       target="_blank" class="text-red-600 underline hover:text-red-800">
                        Click here to manage Firestore indexes
                    </a>
                `;
            }
        }

        // Display payments in table
        function displayPayments() {
            tableBody.innerHTML = '';
            
            // Update record count and subtitle
            recordCount.textContent = `${orders.length} record${orders.length !== 1 ? 's' : ''}`;
            
            if (currentOrderId) {
                tableSubtitle.textContent = `Showing details for order: ${currentOrderId}`;
            } else {
                tableSubtitle.textContent = `${orders.length} pending payment${orders.length !== 1 ? 's' : ''} requiring verification`;
            }
            
            orders.forEach((order, index) => {
                const row = document.createElement('tr');
                row.className = 'hover-lift hover:bg-slate-50 transition-all duration-300';
                
                const createdAt = order.createdAt?.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                const formattedDate = createdAt.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const formattedTime = createdAt.toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });

                row.innerHTML = `
                    <td class="px-3 py-3">
                        <div class="w-6 h-6 bg-blue-100 text-blue-800 rounded-full flex items-center justify-center text-xs font-bold">
                            ${index + 1}
                        </div>
                    </td>
                    <td class="px-3 py-3">
                        <span class="font-semibold text-slate-800 bg-slate-100 px-2 py-1 rounded-lg text-xs">
                            ${order.id}
                        </span>
                    </td>
                    <td class="px-3 py-3">
                        <span class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium px-2 py-1 rounded-lg hover:bg-blue-50 transition-colors text-xs"
                              data-address="${escapeHtml(order.shippingDetails?.address || 'No address available')}" 
                              onmouseenter="showPopup(event, this)" 
                              onmouseleave="hidePopup()">
                            Customer ${order.customerId}
                        </span>
                    </td>
                    <td class="px-3 py-3 text-slate-600 text-xs">
                        <div>${formattedDate}</div>
                        <div class="text-slate-500">${formattedTime}</div>
                    </td>
                    <td class="px-3 py-3">
                        <span class="text-green-600 font-bold text-sm">
                            â‚¹${parseFloat(order.totalAmount).toLocaleString('en-IN')}
                        </span>
                    </td>
                    <td class="px-3 py-3">
                        <code class="bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs font-mono">
                            ${order.upiTransactionId || 'N/A'}
                        </code>
                    </td>
                    <td class="px-3 py-3">
                        <div class="max-w-xs">
                            <span class="text-xs text-slate-600 bg-yellow-50 px-2 py-1 rounded border-l-2 border-yellow-400 block">
                                ${order.upiNote || 'No note'}
                            </span>
                        </div>
                    </td>
                    <td class="px-3 py-3">
                        <button class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none text-xs"
                                onclick="verifyPayment('${order.id}', this)">
                            Verify
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Show popup on hover
        function showPopup(event, element) {
            const address = element.getAttribute('data-address');
            popup.textContent = address;
            
            const rect = element.getBoundingClientRect();
            popup.style.left = rect.left + 'px';
            popup.style.top = (rect.bottom + 10) + 'px';
            
            popup.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
            popup.classList.add('opacity-100', 'translate-y-0');
        }

        // Hide popup
        function hidePopup() {
            popup.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
            popup.classList.remove('opacity-100', 'translate-y-0');
        }

        // Verify payment
        async function verifyPayment(orderId, button) {
            try {
                button.disabled = true;
                button.textContent = 'Verifying...';
                button.className = button.className.replace('from-green-500 to-green-600 hover:from-green-600 hover:to-green-700', 'from-slate-400 to-slate-500');

                await db.collection('orders').doc(orderId).update({
                    paymentStatus: 'verified',
                    verifiedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Animate row removal
                const row = button.closest('tr');
                row.style.opacity = '0';
                row.style.transform = 'translateX(100px)';
                
                setTimeout(() => {
                    row.remove();
                    
                    // Update serial numbers
                    const rows = tableBody.querySelectorAll('tr');
                    rows.forEach((r, index) => {
                        const serialCell = r.querySelector('div');
                        if (serialCell && serialCell.classList.contains('w-6')) {
                            serialCell.textContent = index + 1;
                        }
                    });

                    // Update record count
                    recordCount.textContent = `${rows.length} record${rows.length !== 1 ? 's' : ''}`;
                    
                    if (currentOrderId) {
                        tableSubtitle.textContent = rows.length > 0 ? `Showing details for order: ${currentOrderId}` : 'Order verified successfully';
                    } else {
                        tableSubtitle.textContent = `${rows.length} pending payment${rows.length !== 1 ? 's' : ''} requiring verification`;
                    }

                    // Check if table is empty
                    if (rows.length === 0) {
                        tableContainer.style.display = 'none';
                        noData.style.display = 'block';
                        if (currentOrderId) {
                            document.querySelector('#noData h3').textContent = 'Payment Verified!';
                            document.querySelector('#noData p').textContent = `Order ${currentOrderId} has been successfully verified.`;
                        }
                    }
                }, 300);

                // Remove from orders array
                orders = orders.filter(order => order.id !== orderId);

            } catch (err) {
                console.error('Error verifying payment:', err);
                button.disabled = false;
                button.textContent = 'Verify';
                button.className = button.className.replace('from-slate-400 to-slate-500', 'from-green-500 to-green-600 hover:from-green-600 hover:to-green-700');
                
                // Show error notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300 text-sm';
                notification.textContent = 'Error verifying payment: ' + err.message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Initialize page
        function init() {
            loadPendingPayments();
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', init);

        // Update when URL changes
        window.addEventListener('popstate', init);
    </script>
</body>
</html>