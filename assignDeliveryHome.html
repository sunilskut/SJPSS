<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Assignment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <style>
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-bg-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .gradient-bg-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .gradient-bg-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip.show {
            visibility: visible;
            opacity: 1;
        }
        @media (max-width: 768px) {
            .mobile-table-row {
                border-radius: 12px;
                margin-bottom: 12px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Dashboard View -->
    <div id="dashboardView" class="container mx-auto px-4 py-8">
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">Delivery Assignment</h1>
            <p class="text-gray-600 text-lg">Assign Orders to Delivery Staff</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto">
            <!-- Unassigned Orders Card -->
            <div class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer gradient-bg text-white" onclick="showView('unassigned')">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <span id="unassignedCount" class="text-2xl font-bold">0</span>
                </div>
                <h3 class="text-xl font-semibold mb-2">Unassigned Orders</h3>
                <p class="text-white text-opacity-80">Orders waiting for staff assignment</p>
            </div>

            <!-- Bulk Assignment Card -->
            <div class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer gradient-bg-2 text-white" onclick="showView('bulk')">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold">âˆž</span>
                </div>
                <h3 class="text-xl font-semibold mb-2">Bulk Assignment</h3>
                <p class="text-white text-opacity-80">Assign multiple orders at once</p>
            </div>

            <!-- Change Assignment Card -->
            <div class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer gradient-bg-3 text-white" onclick="showView('change')">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span id="assignedCount" class="text-2xl font-bold">0</span>
                </div>
                <h3 class="text-xl font-semibold mb-2">Change Assignment</h3>
                <p class="text-white text-opacity-80">Reassign orders to different staff</p>
            </div>

            <!-- Others Card -->
            <div class="card-hover bg-white rounded-2xl shadow-lg p-6 cursor-pointer gradient-bg-4 text-white" onclick="showView('others')">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 8a2 2 0 110 4 2 2 0 010-4zM10 16a2 2 0 110-4 2 2 0 010 4z"/>
                        </svg>
                    </div>
                    <span class="text-2xl font-bold">â€¢â€¢â€¢</span>
                </div>
                <h3 class="text-xl font-semibold mb-2">Others</h3>
                <p class="text-white text-opacity-80">Additional features coming soon</p>
            </div>
        </div>
    </div>

    <!-- Unassigned Orders View -->
    <div id="unassignedView" class="hidden container mx-auto px-4 py-8">
        <div class="flex items-center justify-between mb-8">
            <div>
                <button onclick="showView('dashboard')" class="flex items-center text-blue-600 hover:text-blue-800 mb-4">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Back to Dashboard
                </button>
                <h1 class="text-3xl font-bold text-gray-800">Unassigned Orders</h1>
            </div>
        </div>
        
        <div id="unassignedOrdersContainer" class="space-y-6">
            <!-- Orders will be loaded here -->
        </div>
        
        <div id="unassignedLoading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Loading orders...</p>
        </div>
    </div>

    <!-- Bulk Assignment View -->
    <div id="bulkView" class="hidden container mx-auto px-4 py-8">
        <div class="flex items-center justify-between mb-8">
            <div>
                <button onclick="showView('dashboard')" class="flex items-center text-blue-600 hover:text-blue-800 mb-4">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Back to Dashboard
                </button>
                <h1 class="text-3xl font-bold text-gray-800">Bulk Assignment</h1>
            </div>
            <div class="flex space-x-4">
                <select id="bulkStaffSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Staff</option>
                </select>
                <button onclick="bulkAssignSelected()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    Assign Selected
                </button>
            </div>
        </div>
        
        <div id="bulkOrdersContainer" class="space-y-4">
            <!-- Bulk orders will be loaded here -->
        </div>
    </div>

    <!-- Change Assignment View -->
    <div id="changeView" class="hidden container mx-auto px-4 py-8">
        <div class="flex items-center justify-between mb-8">
            <div>
                <button onclick="showView('dashboard')" class="flex items-center text-blue-600 hover:text-blue-800 mb-4">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Back to Dashboard
                </button>
                <h1 class="text-3xl font-bold text-gray-800">Change Assignment</h1>
            </div>
        </div>
        
        <div id="changeOrdersContainer" class="space-y-6">
            <!-- Change assignment orders will be loaded here -->
        </div>
        
        <div id="changeLoading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Loading assigned orders...</p>
        </div>
    </div>

    <!-- Others View -->
    <div id="othersView" class="hidden container mx-auto px-4 py-8">
        <div class="flex items-center justify-between mb-8">
            <div>
                <button onclick="showView('dashboard')" class="flex items-center text-blue-600 hover:text-blue-800 mb-4">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Back to Dashboard
                </button>
                <h1 class="text-3xl font-bold text-gray-800">Others</h1>
            </div>
        </div>
        
        <div class="text-center py-16">
            <div class="text-gray-400 text-6xl mb-4">ðŸš§</div>
            <h2 class="text-2xl font-semibold text-gray-600 mb-2">Coming Soon</h2>
            <p class="text-gray-500">Additional features will be available here soon.</p>
        </div>
    </div>

    <!-- Staff Assignment Modal -->
    <div id="staffModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Assign Delivery Staff</h3>
                    <button onclick="closeStaffModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="staffList" class="space-y-3 max-h-60 overflow-y-auto">
                    <!-- Staff list will be loaded here -->
                </div>
                
                <div id="staffLoading" class="text-center py-4">
                    <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-sm text-gray-600">Loading staff...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3iBWleWNMCdQS9F0HR1wHBBtHkeMawhg",
            authDomain: "sjpss-f504b.firebaseapp.com",
            projectId: "sjpss-f504b",
            storageBucket: "sjpss-f504b.firebasestorage.app",
            messagingSenderId: "227402980311",
            appId: "1:227402980311:web:56b580456ab6b9c6758992",
            measurementId: "G-LZ4YP9YPN6"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let currentOrderId = null;
        let products = {};
        let allStaff = [];
        let selectedOrders = [];
        const userId = sessionStorage.getItem('userId');
        
        // View management
        function showView(viewName) {
            const views = ['dashboardView', 'unassignedView', 'bulkView', 'changeView', 'othersView'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            
            document.getElementById(viewName + 'View').classList.remove('hidden');
            
            // Load data based on view
            if (viewName === 'unassigned') {
                loadUnassignedOrders();
            } else if (viewName === 'bulk') {
                loadBulkOrders();
                loadStaffForBulk();
            } else if (viewName === 'change') {
                loadAssignedOrders();
            } else if (viewName === 'dashboard') {
                loadDashboardCounts();
            }
        }
        
        // Load products
        async function loadProducts() {
            try {
                const productsSnapshot = await db.collection('products').get();
                productsSnapshot.forEach(doc => {
                    products[doc.id] = doc.data();
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // Load staff
        async function loadStaff() {
            try {
                const staffSnapshot = await db.collection('users')
                    .where('role', '==', 'deliveryStaff')
                    .get();
                
                allStaff = [];
                staffSnapshot.forEach(doc => {
                    allStaff.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }
        
        // Load dashboard counts
        async function loadDashboardCounts() {
            try {
                const unassignedSnapshot = await db.collection('orders')
                    .where('status', '==', 'packed')
                    .get();
                
                const unassignedOrders = unassignedSnapshot.docs.filter(doc => doc.data().deliveryStaff == null);
                const assignedOrders = unassignedSnapshot.docs.filter(doc => doc.data().deliveryStaff != null);
                
                document.getElementById('unassignedCount').textContent = unassignedOrders.length;
                document.getElementById('assignedCount').textContent = assignedOrders.length;
            } catch (error) {
                console.error('Error loading counts:', error);
            }
        }
        
        // Load unassigned orders
        async function loadUnassignedOrders() {
            try {
                await loadProducts();
                
                const ordersSnapshot = await db.collection('orders')
                    .where('status', '==', 'packed')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const unassignedOrders = ordersSnapshot.docs.filter(doc => doc.data().deliveryStaff == null);
                
                const container = document.getElementById('unassignedOrdersContainer');
                const loading = document.getElementById('unassignedLoading');
                
                container.innerHTML = '';
                
                if (unassignedOrders.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No unassigned orders found</p>';
                    loading.style.display = 'none';
                    return;
                }
                
                unassignedOrders.forEach(doc => {
                    const order = doc.data();
                    const orderElement = createOrderElement(doc.id, order, false);
                    container.appendChild(orderElement);
                });
                
                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading unassigned orders:', error);
                document.getElementById('unassignedLoading').innerHTML = '<p class="text-red-500">Error loading orders</p>';
            }
        }
        
        // Load bulk orders
        async function loadBulkOrders() {
            try {
                await loadProducts();
                
                const ordersSnapshot = await db.collection('orders')
                    .where('status', '==', 'packed')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const unassignedOrders = ordersSnapshot.docs.filter(doc => doc.data().deliveryStaff == null);
                
                const container = document.getElementById('bulkOrdersContainer');
                container.innerHTML = '';
                
                if (unassignedOrders.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No orders available for bulk assignment</p>';
                    return;
                }
                
                unassignedOrders.forEach(doc => {
                    const order = doc.data();
                    const orderElement = createBulkOrderElement(doc.id, order);
                    container.appendChild(orderElement);
                });
                
            } catch (error) {
                console.error('Error loading bulk orders:', error);
            }
        }
        
        // Load assigned orders
        async function loadAssignedOrders() {
            try {
                await loadProducts();
                
                const ordersSnapshot = await db.collection('orders')
                    .where('status', '==', 'packed')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const assignedOrders = ordersSnapshot.docs.filter(doc => doc.data().deliveryStaff != null);
                
                const container = document.getElementById('changeOrdersContainer');
                const loading = document.getElementById('changeLoading');
                
                container.innerHTML = '';
                
                if (assignedOrders.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No assigned orders found</p>';
                    loading.style.display = 'none';
                    return;
                }
                
                assignedOrders.forEach(doc => {
                    const order = doc.data();
                    const orderElement = createOrderElement(doc.id, order, true);
                    container.appendChild(orderElement);
                });
                
                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading assigned orders:', error);
                document.getElementById('changeLoading').innerHTML = '<p class="text-red-500">Error loading orders</p>';
            }
        }
        
        // Create order element (responsive)
        function createOrderElement(orderId, order, isAssigned) {
            const orderDiv = document.createElement('div');
            const isMobile = window.innerWidth < 768;
            
            if (isMobile) {
                orderDiv.className = 'mobile-table-row bg-white p-4 relative';
                orderDiv.innerHTML = createMobileOrderHTML(orderId, order, isAssigned);
            } else {
                orderDiv.className = 'bg-white rounded-lg shadow-md p-6 border border-gray-200';
                orderDiv.innerHTML = createDesktopOrderHTML(orderId, order, isAssigned);
            }
            
            return orderDiv;
        }
        
        // Create mobile order HTML
        function createMobileOrderHTML(orderId, order, isAssigned) {
            const createdAt = new Date(order.createdAt).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            
            const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
            
            return `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-800">#${orderId.slice(-6)}</h3>
                        <p class="text-xs text-gray-500">${createdAt}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-blue-600">â‚¹${order.totalAmount}</p>
                        <p class="text-xs text-gray-500">${totalItems} items</p>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="flex-1">
                        <p class="text-xs text-gray-600 truncate">${order.shippingDetails.address}</p>
                        <p class="text-xs text-gray-500">${order.paymentMethod}</p>
                    </div>
                    <button 
                        onclick="${isAssigned ? `openStaffModal('${orderId}')` : `openStaffModal('${orderId}')`}" 
                        class="ml-3 px-3 py-1 text-xs ${isAssigned ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-500 hover:bg-blue-600'} text-white rounded-full font-medium"
                    >
                        ${isAssigned ? 'Change' : 'Assign'}
                    </button>
                </div>
                
                <!-- Tooltip content -->
                <div class="absolute left-0 top-full mt-2 w-80 bg-gray-800 text-white p-4 rounded-lg shadow-lg tooltip z-10" id="tooltip-${orderId}">
                    <h4 class="font-medium mb-2">Order Details</h4>
                    <div class="space-y-1 text-sm">
                        ${order.items.map(item => {
                            const productName = products[item.productId]?.name || `Product ${item.productId}`;
                            return `<p>${productName} x${item.quantity} - â‚¹${item.price}</p>`;
                        }).join('')}
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-600">
                        <p class="text-sm"><strong>Address:</strong> ${order.shippingDetails.address}</p>
                        <p class="text-sm"><strong>Pincode:</strong> ${order.shippingDetails.pincode}</p>
                        ${isAssigned ? `<p class="text-sm"><strong>Staff:</strong> ${order.deliveryStaff}</p>` : ''}
                    </div>
                </div>
            `;
        }
        
        // Create desktop order HTML (original format)
        function createDesktopOrderHTML(orderId, order, isAssigned) {
            const createdAt = new Date(order.createdAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const itemsHtml = order.items.map(item => {
                const productName = products[item.productId]?.name || `Product ${item.productId}`;
                return `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                        <div>
                            <span class="font-medium text-gray-800">${productName}</span>
                            <span class="text-sm text-gray-600 ml-2">Qty: ${item.quantity}</span>
                        </div>
                        <span class="font-semibold text-gray-800">â‚¹${item.price}</span>
                    </div>
                `;
            }).join('');
            
            const statusColor = 'bg-green-100 text-green-800';
            const paymentStatusColor = order.paymentStatus === 'pending' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            
            const deliveryStaffInfo = order.deliveryStaff ? 
                `<div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <span class="text-sm font-medium text-green-800">Assigned to Staff: ${order.deliveryStaff}</span>
                </div>` : '';
            
            return `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Order #${orderId.slice(-8)}</h3>
                        <p class="text-sm text-gray-600">${createdAt}</p>
                    </div>
                    <div class="flex space-x-2">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor}">${order.status}</span>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${paymentStatusColor}">${order.paymentStatus}</span>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium text-gray-800 mb-3">Items</h4>
                        <div class="space-y-1">
                            ${itemsHtml}
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex justify-between items-center font-semibold text-lg">
                                <span>Total Amount:</span>
                                <span class="text-blue-600">â‚¹${order.totalAmount}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-gray-800 mb-3">Shipping Details</h4>
                        <div class="space-y-2 text-sm text-gray-600">
                            <p><span class="font-medium">Address:</span> ${order.shippingDetails.address}</p>
                            <p><span class="font-medium">Pincode:</span> ${order.shippingDetails.pincode}</p>
                            <p><span class="font-medium">Method:</span> ${order.shippingDetails.method}</p>
                        </div>
                        
                        <div class="mt-4">
                            <p class="text-sm text-gray-600 mb-2"><span class="font-medium">Payment Method:</span> ${order.paymentMethod}</p>
                            <p class="text-sm text-gray-600"><span class="font-medium">Customer ID:</span> ${order.customerId}</p>
                        </div>
                    </div>
                </div>
                
                ${deliveryStaffInfo}
                
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <button 
                        onclick="openStaffModal('${orderId}')" 
                        class="px-6 py-2 ${isAssigned ? 'bg-orange-600 hover:bg-orange-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-lg transition-colors duration-200 font-medium"
                    >
                        ${isAssigned ? 'Change Staff Assignment' : 'Assign Staff'}
                    </button>
                </div>
            `;
        }
        
        // Create bulk order element
        function createBulkOrderElement(orderId, order) {
            const orderDiv = document.createElement('div');
            orderDiv.className = 'bg-white rounded-lg shadow-md p-4 border border-gray-200 flex items-center justify-between';
            
            const createdAt = new Date(order.createdAt).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
            
            const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
            
            orderDiv.innerHTML = `
                <div class="flex items-center space-x-4">
                    <input 
                        type="checkbox" 
                        id="bulk-${orderId}" 
                        onchange="toggleBulkSelection('${orderId}')"
                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <div>
                        <h3 class="text-sm font-semibold text-gray-800">Order #${orderId.slice(-8)}</h3>
                        <p class="text-xs text-gray-500">${createdAt} â€¢ ${totalItems} items</p>
                    </div>
                </div>
                
                <div class="text-right">
                    <p class="text-sm font-bold text-blue-600">â‚¹${order.totalAmount}</p>
                    <p class="text-xs text-gray-500 truncate max-w-32">${order.shippingDetails.address}</p>
                </div>
            `;
            
            return orderDiv;
        }
        
        // Toggle bulk selection
        function toggleBulkSelection(orderId) {
            const checkbox = document.getElementById(`bulk-${orderId}`);
            if (checkbox.checked) {
                selectedOrders.push(orderId);
            } else {
                selectedOrders = selectedOrders.filter(id => id !== orderId);
            }
        }
        
        // Load staff for bulk assignment
        async function loadStaffForBulk() {
            await loadStaff();
            const select = document.getElementById('bulkStaffSelect');
            select.innerHTML = '<option value="">Select Staff</option>';
            
            allStaff.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                option.textContent = staff.name || staff.email || staff.id;
                select.appendChild(option);
            });
        }
        
        // Bulk assign selected orders
        async function bulkAssignSelected() {
            const staffSelect = document.getElementById('bulkStaffSelect');
            const selectedStaff = staffSelect.value;
            
            if (!selectedStaff) {
                alert('Please select a staff member');
                return;
            }
            
            if (selectedOrders.length === 0) {
                alert('Please select at least one order');
                return;
            }
            
            try {
                const batch = db.batch();
                
                selectedOrders.forEach(orderId => {
                    const orderRef = db.collection('orders').doc(orderId);
                    batch.update(orderRef, {
                        deliveryStaff: selectedStaff,
                        assignDeliveryStaffBy: userId
                    });
                });
                
                await batch.commit();
                
                alert(`Successfully assigned ${selectedOrders.length} orders to staff`);
                selectedOrders = [];
                loadBulkOrders();
                loadDashboardCounts();
                
            } catch (error) {
                console.error('Error bulk assigning orders:', error);
                alert('Error assigning orders. Please try again.');
            }
        }
        
        // Open staff modal
        async function openStaffModal(orderId) {
            currentOrderId = orderId;
            const modal = document.getElementById('staffModal');
            const staffList = document.getElementById('staffList');
            const staffLoading = document.getElementById('staffLoading');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            staffList.innerHTML = '';
            staffLoading.style.display = 'block';
            
            try {
                await loadStaff();
                staffLoading.style.display = 'none';
                
                if (allStaff.length === 0) {
                    staffList.innerHTML = '<p class="text-gray-500 text-center py-4">No delivery staff available</p>';
                    return;
                }
                
                allStaff.forEach(staff => {
                    const staffElement = document.createElement('div');
                    staffElement.className = 'flex justify-between items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50';
                    
                    staffElement.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${staff.name || 'Unnamed Staff'}</p>
                            <p class="text-sm text-gray-600">${staff.email || staff.id}</p>
                        </div>
                        <button 
                            onclick="assignStaff('${staff.id}')" 
                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200 text-sm font-medium"
                        >
                            Assign
                        </button>
                    `;
                    
                    staffList.appendChild(staffElement);
                });
                
            } catch (error) {
                console.error('Error loading staff:', error);
                staffLoading.innerHTML = '<p class="text-red-500 text-center">Error loading staff</p>';
            }
        }
        
        // Close staff modal
        function closeStaffModal() {
            const modal = document.getElementById('staffModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentOrderId = null;
        }
        
       // Assign staff to order
async function assignStaff(staffId) {
    if (!currentOrderId) return;

    try {
        // Step 1: Update the order with delivery staff info
        await db.collection('orders').doc(currentOrderId).update({
            deliveryStaff: staffId,
            assignDeliveryStaffBy: userId,
            updatedAt: firebase.firestore.Timestamp.now() // optional
        });

        // Step 2: Handle notification
        await db.collection('notifications').add({
            userId: staffId,
            type: 'order_assigned',
            orderId: currentOrderId,
            message: `You have been assigned to Order #${currentOrderId}`,
            isRead: false,
            timestamp: firebase.firestore.Timestamp.now()
        });

        // Step 3: UI updates
        closeStaffModal();

        const currentView = getCurrentView();
        if (currentView === 'unassigned') {
            loadUnassignedOrders();
        } else if (currentView === 'change') {
            loadAssignedOrders();
        } else if (currentView === 'bulk') {
            loadBulkOrders();
        }

        loadDashboardCounts();

    } catch (error) {
        console.error('Error assigning staff:', error);
        alert('Error assigning staff. Please try again.');
    }
}

        
        // Get current view
        function getCurrentView() {
            if (!document.getElementById('unassignedView').classList.contains('hidden')) return 'unassigned';
            if (!document.getElementById('bulkView').classList.contains('hidden')) return 'bulk';
            if (!document.getElementById('changeView').classList.contains('hidden')) return 'change';
            return 'dashboard';
        }
        
        // Mobile tooltip functionality
        function showTooltip(orderId) {
            const tooltip = document.getElementById(`tooltip-${orderId}`);
            if (tooltip) {
                tooltip.classList.add('show');
            }
        }
        
        function hideTooltip(orderId) {
            const tooltip = document.getElementById(`tooltip-${orderId}`);
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', async () => {
            await loadProducts();
            await loadStaff();
            loadDashboardCounts();
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            const currentView = getCurrentView();
            if (currentView === 'unassigned') {
                loadUnassignedOrders();
            } else if (currentView === 'change') {
                loadAssignedOrders();
            }
        });
        
        // Close modal when clicking outside
        document.getElementById('staffModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeStaffModal();
            }
        });
        
        // Add mobile touch events for tooltips
        document.addEventListener('touchstart', function(e) {
            if (window.innerWidth < 768) {
                const orderElement = e.target.closest('.mobile-table-row');
                if (orderElement) {
                    const orderId = orderElement.querySelector('h3').textContent.replace('#', '');
                    showTooltip(orderId);
                    
                    // Hide tooltip after 3 seconds
                    setTimeout(() => hideTooltip(orderId), 3000);
                }
            }
        });
    </script>
</body>
</html>