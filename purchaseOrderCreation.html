<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Purchase Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <style>
        .vendor-card:hover {
            transform: translateY(-2px);
        }
        .selected-vendor {
            border-color: #3B82F6;
            background-color: #EFF6FF;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #DC2626;
            background-color: #FEE2E2;
            border: 1px solid #FECACA;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="py-8">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Loading State -->
            <div id="loadingState" class="hidden">
                <div class="bg-white shadow-xl rounded-lg p-8 text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading data from Firebase...</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden">
                <div class="bg-white shadow-xl rounded-lg p-8">
                    <div class="error-message">
                        <h3 class="font-semibold">Error loading data</h3>
                        <p id="errorMessage"></p>
                        <button id="retryBtn" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            Retry
                        </button>
                    </div>
                </div>
            </div>

            <div id="mainContent" class="bg-white shadow-xl rounded-lg overflow-hidden hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                    <h1 class="text-2xl font-bold text-white flex items-center">
                        <i data-lucide="file-text" class="mr-3"></i>
                        Create Purchase Order
                    </h1>
                </div>

                <div class="p-6 space-y-8">
                    <!-- PO Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">PO Number</label>
                            <input type="text" id="poId" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">PO Date</label>
                            <input type="date" id="poDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Expected Delivery Date</label>
                            <input type="date" id="expectedDeliveryDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Vendor Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Select Vendor</label>
                        <div id="vendorsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Vendors will be populated here -->
                        </div>
                    </div>

                    <!-- Available Products -->
                    <div id="productsSection" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i data-lucide="package" class="mr-2"></i>
                            Available Products from <span id="selectedVendorName"></span>
                        </h3>
                        <div id="availableProductsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- Available products will be populated here -->
                        </div>
                    </div>

                    <!-- Selected Products -->
                    <div id="selectedProductsSection" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Selected Products</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="selectedProductsTable" class="bg-white divide-y divide-gray-200">
                                    <!-- Selected products will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Totals -->
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="font-medium text-gray-700">Total Quantity:</span>
                                    <p id="totalQuantity" class="text-lg font-semibold text-gray-900">0</p>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Subtotal:</span>
                                    <p id="subtotalAmount" class="text-lg font-semibold text-gray-900">₹0.00</p>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Total Tax:</span>
                                    <p id="totalTax" class="text-lg font-semibold text-gray-900">₹0.00</p>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">Grand Total:</span>
                                    <p id="totalAmount" class="text-xl font-bold text-blue-600">₹0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Terms</label>
                            <textarea id="paymentTerms" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Net 30 days, 2/10 net 30, etc."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Remarks</label>
                            <textarea id="remarks" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Internal notes and remarks..."></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                        <button id="saveDraftBtn" class="inline-flex items-center px-6 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                            Save as Draft
                        </button>
                        <button id="submitBtn" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="send" class="w-5 h-5 mr-2"></i>
                            Submit for Approval
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3iBWleWNMCdQS9F0HR1wHBBtHkeMawhg",
            authDomain: "sjpss-f504b.firebaseapp.com",
            projectId: "sjpss-f504b",
            storageBucket: "sjpss-f504b.firebasestorage.app",
            messagingSenderId: "227402980311",
            appId: "1:227402980311:web:56b580456ab6b9c6758992",
            measurementId: "G-LZ4YP9YPN6"
        };

        // Firebase initialization
        let db = null;
        let auth = null;
        let vendors = [];
        let products = [];
        let selectedVendor = '';
        let selectedProducts = [];
        let nextPONumber = 1;

        let poData = {
            poId: '',
            vendorId: '',
            poDate: new Date().toISOString().split('T')[0],
            expectedDeliveryDate: '',
            status: 'draft',
            totalQuantity: 0,
            subtotalAmount: 0,
            totalTax: 0,
            totalAmount: 0,
            currency: 'INR',
            paymentStatus: 'unpaid',
            paymentTerms: '',
            createdBy: 'current-user-id',
            approvedBy: '',
            remarks: ''
        };

        // Initialize Firebase and load data
        function initializeApp() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Show loading and start data loading
                document.getElementById('loadingState').classList.remove('hidden');
                loadData();
            } catch (error) {
                showError('Failed to initialize Firebase: ' + error.message);
            }
        }

        // Load data from Firestore
        async function loadData() {
            try {
                // Generate next PO number
                await generateNextPONumber();
                
                // Load vendors and products concurrently
                await Promise.all([loadVendors(), loadProducts()]);
                
                // Initialize the UI
                setupEventListeners();
                renderVendors();
                document.getElementById('poDate').value = poData.poDate;
                
                // Show main content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } catch (error) {
                showError('Failed to load data: ' + error.message);
            }
        }

        // Generate next PO number by checking existing POs
        async function generateNextPONumber() {
            try {
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
                const yearMonth = `${dateStr.substring(0,4)}-${dateStr.substring(4,8)}`;
                
                // Get all POs and filter in JavaScript to avoid needing indexes
                const snapshot = await db.collection('purchaseOrders').get();
                
                let maxNumber = 0;
                snapshot.forEach(doc => {
                    const poId = doc.data().poId;
                    if (poId && poId.includes(yearMonth)) {
                        const parts = poId.split('-');
                        if (parts.length >= 4) {
                            const number = parseInt(parts[3]);
                            if (number > maxNumber) {
                                maxNumber = number;
                            }
                        }
                    }
                });

                nextPONumber = maxNumber + 1;
                const poId = `PO-${yearMonth}-${nextPONumber.toString().padStart(4, '0')}`;
                poData.poId = poId;
                document.getElementById('poId').value = poId;
            } catch (error) {
                console.error('Error generating PO number:', error);
                // Fallback to random number
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
                const poNumber = Math.floor(Math.random() * 9999) + 1;
                const poId = `PO-${dateStr.substring(0,4)}-${dateStr.substring(4,8)}-${poNumber.toString().padStart(4, '0')}`;
                poData.poId = poId;
                document.getElementById('poId').value = poId;
            }
        }

        // Load vendors from Firestore
        async function loadVendors() {
            try {
                const snapshot = await db.collection('vendors').get();
                
                vendors = [];
                snapshot.forEach(doc => {
                    const vendorData = doc.data();
                    // Filter for active vendors in JavaScript instead of Firestore
                    if (vendorData.isActive === true) {
                        vendors.push({
                            id: doc.id,
                            ...vendorData
                        });
                    }
                });
                
                // Sort by company name in JavaScript
                vendors.sort((a, b) => (a.companyName || '').localeCompare(b.companyName || ''));
                
                console.log(`Loaded ${vendors.length} active vendors`);
            } catch (error) {
                console.error('Error loading vendors:', error);
                throw error;
            }
        }

        // Load products from Firestore
        async function loadProducts() {
            try {
                const snapshot = await db.collection('products').get();
                
                products = [];
                snapshot.forEach(doc => {
                    const productData = doc.data();
                    // Filter for active and in-stock products in JavaScript instead of Firestore
                    if (productData.status === 'active' && productData.stockStatus === 'in_stock') {
                        products.push({
                            id: doc.id,
                            ...productData
                        });
                    }
                });
                
                // Sort by name in JavaScript
                products.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                console.log(`Loaded ${products.length} active products`);
            } catch (error) {
                console.error('Error loading products:', error);
                throw error;
            }
        }

        // Show error state
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Retry button
            document.getElementById('retryBtn').addEventListener('click', function() {
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('loadingState').classList.remove('hidden');
                loadData();
            });

            // Form inputs
            document.getElementById('poDate').addEventListener('change', function(e) {
                poData.poDate = e.target.value;
            });

            document.getElementById('expectedDeliveryDate').addEventListener('change', function(e) {
                poData.expectedDeliveryDate = e.target.value;
            });

            document.getElementById('paymentTerms').addEventListener('input', function(e) {
                poData.paymentTerms = e.target.value;
            });

            document.getElementById('remarks').addEventListener('input', function(e) {
                poData.remarks = e.target.value;
            });

            // Action buttons
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                handleSubmit('draft');
            });

            document.getElementById('submitBtn').addEventListener('click', function() {
                handleSubmit('approved');
            });
        }

        // Render vendors
        function renderVendors() {
            const container = document.getElementById('vendorsContainer');
            container.innerHTML = '';

            if (vendors.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">No active vendors found</p>';
                return;
            }

            vendors.forEach(vendor => {
                const vendorCard = document.createElement('div');
                vendorCard.className = 'vendor-card p-4 border-2 rounded-lg cursor-pointer transition-all duration-200 border-gray-200 hover:border-gray-300 hover:shadow-sm';
                vendorCard.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-900">${vendor.companyName || 'N/A'}</h3>
                            <p class="text-sm text-gray-600 mt-1">${vendor.name || 'N/A'}</p>
                            <p class="text-sm text-gray-500">${vendor.city || 'N/A'}</p>
                            <div class="flex items-center mt-2">
                                <span class="text-yellow-500">★</span>
                                <span class="text-sm text-gray-600 ml-1">${vendor.rating || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <i data-lucide="user" class="h-5 w-5 text-gray-400"></i>
                        </div>
                    </div>
                `;
                vendorCard.addEventListener('click', () => selectVendor(vendor.vendorId || vendor.id));
                container.appendChild(vendorCard);
            });

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Select vendor
        function selectVendor(vendorId) {
            selectedVendor = vendorId;
            poData.vendorId = vendorId;
            
            // Update vendor cards appearance
            document.querySelectorAll('.vendor-card').forEach(card => {
                card.classList.remove('selected-vendor');
            });
            event.currentTarget.classList.add('selected-vendor');

            // Show vendor name
            const vendor = vendors.find(v => (v.vendorId || v.id) === vendorId);
            document.getElementById('selectedVendorName').textContent = vendor.companyName || 'Selected Vendor';

            // Filter and show products
            const availableProducts = products.filter(product => product.vendors === vendorId);
            renderAvailableProducts(availableProducts);
            
            document.getElementById('productsSection').classList.remove('hidden');
            
            // Reset selected products
            selectedProducts = [];
            updateSelectedProductsDisplay();
        }

        // Render available products
        function renderAvailableProducts(availableProducts) {
            const container = document.getElementById('availableProductsContainer');
            container.innerHTML = '';

            if (availableProducts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">No products found for this vendor</p>';
                return;
            }

            availableProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                
                const isAdded = selectedProducts.some(p => (p.productId || p.id) === (product.productId || product.id));
                
                productCard.innerHTML = `
                    <div class="flex items-start space-x-4">
                        <img src="${product.images || 'https://via.placeholder.com/80x80'}" alt="${product.name || 'Product'}" class="w-20 h-20 object-cover rounded-md">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${product.name || 'N/A'}</h4>
                            <p class="text-sm text-gray-600">${product.brand || 'N/A'} | ${product.subCategory || 'N/A'}</p>
                            <div class="mt-2 space-y-1 text-sm">
                                <p><span class="font-medium">MRP:</span> ₹${product.mrp || 0}</p>
                                <p><span class="font-medium">Selling Price:</span> ₹${product.sellingPrice || 0}</p>
                                <p><span class="font-medium">GST:</span> ${product.gstRate || 0}%</p>
                                <p><span class="font-medium">Min Qty:</span> ${product.minOrderQty || 1} | <span class="font-medium">Max Qty:</span> ${product.maxOrderQty || 100}</p>
                                <p><span class="font-medium">Stock:</span> ${product.stockQuantity || 0} units</p>
                            </div>
                            <button 
                                onclick="addProductToPO('${product.productId || product.id}')"
                                ${isAdded ? 'disabled' : ''}
                                class="mt-3 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-white ${isAdded ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            >
                                <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                                ${isAdded ? 'Added' : 'Add to PO'}
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(productCard);
            });

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Add product to PO
        function addProductToPO(productId) {
            const product = products.find(p => (p.productId || p.id) === productId);
            if (!product) return;

            const existingProduct = selectedProducts.find(p => (p.productId || p.id) === productId);
            if (existingProduct) return;

            const minQty = product.minOrderQty || 1;
            const lineTotal = (product.sellingPrice || 0) * minQty;
            const lineTax = (lineTotal * parseInt(product.gstRate || 0)) / 100;

            selectedProducts.push({
                ...product,
                quantity: minQty,
                lineTotal: lineTotal,
                lineTax: lineTax
            });

            updateSelectedProductsDisplay();
            updateTotals();
            
            // Re-render available products to update button states
            const availableProducts = products.filter(p => p.vendors === selectedVendor);
            renderAvailableProducts(availableProducts);
        }

        // Remove product from PO
        function removeProductFromPO(productId) {
            selectedProducts = selectedProducts.filter(p => (p.productId || p.id) !== productId);
            updateSelectedProductsDisplay();
            updateTotals();
            
            // Re-render available products to update button states
            const availableProducts = products.filter(p => p.vendors === selectedVendor);
            renderAvailableProducts(availableProducts);
        }

        // Update product quantity
        function updateProductQuantity(productId, newQuantity) {
            const productIndex = selectedProducts.findIndex(p => (p.productId || p.id) === productId);
            if (productIndex === -1) return;

            const product = selectedProducts[productIndex];
            const minQty = product.minOrderQty || 1;
            const maxQty = product.maxOrderQty || 1000;
            newQuantity = Math.max(minQty, Math.min(maxQty, newQuantity));
            
            const lineTotal = (product.sellingPrice || 0) * newQuantity;
            const lineTax = (lineTotal * parseInt(product.gstRate || 0)) / 100;

            selectedProducts[productIndex] = {
                ...product,
                quantity: newQuantity,
                lineTotal: lineTotal,
                lineTax: lineTax
            };

            updateSelectedProductsDisplay();
            updateTotals();
        }

        // Update selected products display
        function updateSelectedProductsDisplay() {
            const tbody = document.getElementById('selectedProductsTable');
            const section = document.getElementById('selectedProductsSection');
            
            if (selectedProducts.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            tbody.innerHTML = '';

            selectedProducts.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${product.name || 'N/A'}</div>
                        <div class="text-sm text-gray-500">HSN: ${product.hsnCode || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ₹${product.sellingPrice || 0}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <button onclick="updateProductQuantity('${product.productId || product.id}', ${product.quantity - 1})" class="p-1 text-gray-400 hover:text-gray-600">
                                <i data-lucide="minus" class="w-4 h-4"></i>
                            </button>
                            <input type="number" value="${product.quantity}" onchange="updateProductQuantity('${product.productId || product.id}', parseInt(this.value) || ${product.minOrderQty || 1})" min="${product.minOrderQty || 1}" max="${product.maxOrderQty || 1000}" class="w-16 px-2 py-1 text-center border border-gray-300 rounded text-sm">
                            <button onclick="updateProductQuantity('${product.productId || product.id}', ${product.quantity + 1})" class="p-1 text-gray-400 hover:text-gray-600">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ₹${product.lineTax.toFixed(2)} (${product.gstRate || 0}%)
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ₹${(product.lineTotal + product.lineTax).toFixed(2)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="removeProductFromPO('${product.productId || product.id}')" class="text-red-600 hover:text-red-900 text-sm">
                            Remove
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Update totals
        function updateTotals() {
            const totalQuantity = selectedProducts.reduce((sum, product) => sum + product.quantity, 0);
            const subtotalAmount = selectedProducts.reduce((sum, product) => sum + product.lineTotal, 0);
            const totalTax = selectedProducts.reduce((sum, product) => sum + product.lineTax, 0);
            const totalAmount = subtotalAmount + totalTax;

            poData.totalQuantity = totalQuantity;
            poData.subtotalAmount = subtotalAmount;
            poData.totalTax = totalTax;
            poData.totalAmount = totalAmount;

            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('subtotalAmount').textContent = `₹${subtotalAmount.toFixed(2)}`;
            document.getElementById('totalTax').textContent = `₹${totalTax.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `₹${totalAmount.toFixed(2)}`;

            // Enable/disable buttons
            const hasProducts = selectedProducts.length > 0;
            const hasVendor = selectedVendor !== '';
            
            document.getElementById('saveDraftBtn').disabled = !hasProducts;
            document.getElementById('submitBtn').disabled = !hasProducts || !hasVendor;
        }

        // Handle form submission
        async function handleSubmit(status) {
            try {
                // Show loading state on buttons
                const saveDraftBtn = document.getElementById('saveDraftBtn');
                const submitBtn = document.getElementById('submitBtn');
                const originalSaveText = saveDraftBtn.innerHTML;
                const originalSubmitText = submitBtn.innerHTML;
                
                saveDraftBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
                submitBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
                saveDraftBtn.disabled = true;
                submitBtn.disabled = true;

                const finalPOData = {
                    ...poData,
                    status: status,
                    products: selectedProducts.map(p => ({
                        productId: p.productId || p.id,
                        name: p.name,
                        quantity: p.quantity,
                        unitPrice: p.sellingPrice,
                        lineTotal: p.lineTotal,
                        lineTax: p.lineTax,
                        gstRate: p.gstRate,
                        hsnCode: p.hsnCode
                    })),
                    paymentTerms: document.getElementById('paymentTerms').value,
                    remarks: document.getElementById('remarks').value,
                    linkedGRN: [],
                    linkedPayments: [],
                    attachments: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Save to Firestore using the PO number as document ID
                await db.collection('purchaseOrders').doc(poData.poId).set(finalPOData);
                
                alert(`Purchase Order ${status === 'draft' ? 'saved as draft' : 'submitted for approval'} successfully!`);
                
                // Reset form for new PO
                resetForm();
                
            } catch (error) {
                console.error('Error submitting PO:', error);
                alert('Error submitting Purchase Order: ' + error.message);
            } finally {
                // Restore button states
                const saveDraftBtn = document.getElementById('saveDraftBtn');
                const submitBtn = document.getElementById('submitBtn');
                saveDraftBtn.innerHTML = originalSaveText;
                submitBtn.innerHTML = originalSubmitText;
                updateTotals(); // This will set the correct disabled state
                
                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }

        // Reset form for new PO
        async function resetForm() {
            // Reset selected products and vendor
            selectedProducts = [];
            selectedVendor = '';
            
            // Generate new PO number
            await generateNextPONumber();
            
            // Reset form fields
            document.getElementById('expectedDeliveryDate').value = '';
            document.getElementById('paymentTerms').value = '';
            document.getElementById('remarks').value = '';
            
            // Reset UI
            document.querySelectorAll('.vendor-card').forEach(card => {
                card.classList.remove('selected-vendor');
            });
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('selectedProductsSection').classList.add('hidden');
            
            // Update totals (will disable buttons)
            updateTotals();
            
            // Reset poData
            poData = {
                poId: poData.poId, // Keep the new PO ID
                vendorId: '',
                poDate: new Date().toISOString().split('T')[0],
                expectedDeliveryDate: '',
                status: 'draft',
                totalQuantity: 0,
                subtotalAmount: 0,
                totalTax: 0,
                totalAmount: 0,
                currency: 'INR',
                paymentStatus: 'unpaid',
                paymentTerms: '',
                createdBy: 'current-user-id',
                approvedBy: '',
                remarks: ''
            };
            
            document.getElementById('poDate').value = poData.poDate;
        }

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase and start the app
            initializeApp();
        });
    </script>
</body>
</html>