<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Status Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .success-animation {
            animation: successPulse 0.6s ease-out;
        }
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="card p-6 mb-6 max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Order Dispose Manager</h1>
                    <p class="text-gray-600">Automatically close delivered orders after 7 days</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.location='adminPanel.html#orders'" 
                        class="group inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all duration-200 shadow-sm">
                        <svg class="w-4 h-4 mr-2 transition-transform duration-200 group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Back
                    </button>
                </div>
            </div>

            <!-- Status Display -->
            <div id="statusDisplay" class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="text-sm font-medium text-blue-700">Total Orders Scanned</div>
                        <div id="totalScanned" class="text-2xl font-bold text-blue-900">0</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                        <div class="text-sm font-medium text-yellow-700">Eligible for Closure</div>
                        <div id="eligibleCount" class="text-2xl font-bold text-yellow-900">0</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <div class="text-sm font-medium text-green-700">Successfully Closed</div>
                        <div id="closedCount" class="text-2xl font-bold text-green-900">0</div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div id="progressContainer" class="mb-6" style="display: none;">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Processing Orders</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 mb-6">
                <button id="scanBtn" onclick="scanOrders()" 
                    class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Scan Orders
                </button>
                
                <button id="autoProcessBtn" onclick="autoProcess()" disabled
                    class="inline-flex items-center px-6 py-3 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Auto Process
                </button>

                <button id="bulkUpdateBtn" onclick="bulkUpdate()" disabled
                    class="inline-flex items-center px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors duration-200 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Bulk Update
                </button>

                <button id="resetBtn" onclick="resetData()" 
                    class="inline-flex items-center px-4 py-3 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600 transition-colors duration-200 shadow-sm">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Reset
                </button>
            </div>

            <!-- Results Table -->
            <div id="resultsContainer" style="display: none;">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Orders Eligible for Closure</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50 text-gray-700">
                                <th class="px-4 py-3 text-left font-semibold">Order ID</th>
                                <th class="px-4 py-3 text-left font-semibold">Customer</th>
                                <th class="px-4 py-3 text-left font-semibold">Delivered At</th>
                                <th class="px-4 py-3 text-left font-semibold">Days Ago</th>
                                <th class="px-4 py-3 text-left font-semibold">Amount</th>
                                <th class="px-4 py-3 text-left font-semibold">Status</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Log Container -->
            <div id="logContainer" class="mt-6" style="display: none;">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Processing Log</h3>
                <div id="logContent" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-64 overflow-y-auto">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3iBWleWNMCdQS9F0HR1wHBBtHkeMawhg",
            authDomain: "sjpss-f504b.firebaseapp.com",
            projectId: "sjpss-f504b",
            storageBucket: "sjpss-f504b.firebasestorage.app",
            messagingSenderId: "227402980311",
            appId: "1:227402980311:web:56b580456ab6b9c6758992",
            measurementId: "G-LZ4YP9YPN6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let eligibleOrders = [];
        let processedOrders = [];

        // Get URL parameters
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                orderId: params.get('orderId')
            };
        }

        // Check if delivered date is 7+ days ago
        function isEligibleForClosure(deliveredAt) {
            if (!deliveredAt) return false;
            
            const deliveryDate = new Date(deliveredAt);
            const currentDate = new Date();
            const diffTime = currentDate - deliveryDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays >= 7;
        }

        // Calculate days ago
        function getDaysAgo(dateString) {
            const date = new Date(dateString);
            const currentDate = new Date();
            const diffTime = currentDate - date;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Log function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logContent = document.getElementById('logContent');
            
            logContainer.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : 
                              type === 'success' ? 'text-green-400' : 
                              type === 'warning' ? 'text-yellow-400' : 'text-blue-400';
            
            logContent.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Update progress
        function updateProgress(current, total) {
            if (total === 0) return;
            
            const percentage = Math.round((current / total) * 100);
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressContainer = document.getElementById('progressContainer');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = percentage + '%';
            progressText.textContent = percentage + '%';
        }

        // Update counters
        function updateCounters(scanned = 0, eligible = 0, closed = 0) {
            document.getElementById('totalScanned').textContent = scanned;
            document.getElementById('eligibleCount').textContent = eligible;
            document.getElementById('closedCount').textContent = closed;
        }

        // Render results table
        function renderResultsTable(orders) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsTable = document.getElementById('resultsTable');
            
            if (orders.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            resultsContainer.style.display = 'block';
            
            resultsTable.innerHTML = orders.map(order => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-gray-900">${order.id}</td>
                    <td class="px-4 py-3 text-gray-700">${order.customerId || 'N/A'}</td>
                    <td class="px-4 py-3 text-gray-700">${formatDate(order.deliveredAt)}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                            getDaysAgo(order.deliveredAt) >= 7 ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'
                        }">${getDaysAgo(order.deliveredAt)} days</span>
                    </td>
                    <td class="px-4 py-3 font-semibold text-gray-900">₹${order.totalAmount || 0}</td>
                    <td class="px-4 py-3">
                        <span id="status-${order.id}" class="px-2 py-1 text-xs font-medium rounded-full ${
                            order.status === 'closed' ? 'bg-gray-100 text-gray-800' : 'bg-blue-100 text-blue-800'
                        }">${order.status}</span>
                    </td>
                </tr>
            `).join('');
        }

        // Scan orders
        window.scanOrders = async function() {
            try {
                const scanBtn = document.getElementById('scanBtn');
                const autoProcessBtn = document.getElementById('autoProcessBtn');
                const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
                
                scanBtn.disabled = true;
                scanBtn.innerHTML = '<div class="pulse-dot w-5 h-5 bg-white rounded-full mr-2"></div>Scanning...';
                
                log('Starting order scan...', 'info');
                
                const params = getURLParams();
                let ordersQuery;
                
                if (params.orderId) {
                    log(`Scanning specific order: ${params.orderId}`, 'info');
                    ordersQuery = query(collection(db, 'orders'), where('__name__', '==', params.orderId));
                } else {
                    log('Scanning all orders...', 'info');
                    ordersQuery = collection(db, 'orders');
                }
                
                const snapshot = await getDocs(ordersQuery);
                let scannedCount = 0;
                eligibleOrders = [];
                
                snapshot.forEach((docSnap) => {
                    scannedCount++;
                    const order = { id: docSnap.id, ...docSnap.data() };
                    
                    if (order.status === 'delivered' && order.deliveredAt && isEligibleForClosure(order.deliveredAt)) {
                        eligibleOrders.push(order);
                        log(`Found eligible order: ${order.id} (delivered ${getDaysAgo(order.deliveredAt)} days ago)`, 'success');
                    }
                });
                
                updateCounters(scannedCount, eligibleOrders.length, 0);
                renderResultsTable(eligibleOrders);
                
                if (eligibleOrders.length > 0) {
                    autoProcessBtn.disabled = false;
                    bulkUpdateBtn.disabled = false;
                    log(`Scan complete: ${eligibleOrders.length} orders eligible for closure`, 'success');
                } else {
                    log('Scan complete: No orders eligible for closure', 'warning');
                }
                
                scanBtn.disabled = false;
                scanBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>Scan Orders';
                
            } catch (error) {
                log(`Error scanning orders: ${error.message}`, 'error');
                console.error('Scan error:', error);
            }
        };

        // Auto process
        window.autoProcess = async function() {
            if (eligibleOrders.length === 0) return;
            
            try {
                const autoProcessBtn = document.getElementById('autoProcessBtn');
                autoProcessBtn.disabled = true;
                autoProcessBtn.innerHTML = '<div class="pulse-dot w-5 h-5 bg-white rounded-full mr-2"></div>Processing...';
                
                log(`Starting auto-process for ${eligibleOrders.length} orders...`, 'info');
                
                let processedCount = 0;
                let successCount = 0;
                
                for (let i = 0; i < eligibleOrders.length; i++) {
                    const order = eligibleOrders[i];
                    updateProgress(i + 1, eligibleOrders.length);
                    
                    try {
                        await updateDoc(doc(db, 'orders', order.id), {
                            status: 'closed',
                            closedAt: new Date().toISOString(),
                            closedBy: 'auto-system'
                        });
                        
                        // Update UI
                        const statusElement = document.getElementById(`status-${order.id}`);
                        if (statusElement) {
                            statusElement.textContent = 'closed';
                            statusElement.className = 'px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 success-animation';
                        }
                        
                        successCount++;
                        log(`✓ Order ${order.id} closed successfully`, 'success');
                        
                    } catch (error) {
                        log(`✗ Failed to close order ${order.id}: ${error.message}`, 'error');
                    }
                    
                    processedCount++;
                    updateCounters(document.getElementById('totalScanned').textContent, eligibleOrders.length, successCount);
                    
                    // Small delay to prevent overwhelming Firebase
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                log(`Auto-process complete: ${successCount}/${eligibleOrders.length} orders closed successfully`, 'success');
                
                autoProcessBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Completed';
                
            } catch (error) {
                log(`Auto-process error: ${error.message}`, 'error');
                console.error('Auto-process error:', error);
            }
        };

        // Bulk update
        window.bulkUpdate = async function() {
            if (eligibleOrders.length === 0) return;
            
            if (!confirm(`Are you sure you want to close ${eligibleOrders.length} orders? This action cannot be undone.`)) {
                return;
            }
            
            await window.autoProcess();
        };

        // Reset data
        window.resetData = function() {
            eligibleOrders = [];
            processedOrders = [];
            
            updateCounters(0, 0, 0);
            
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('logContainer').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            
            document.getElementById('autoProcessBtn').disabled = true;
            document.getElementById('bulkUpdateBtn').disabled = true;
            
            log('Data reset completed', 'info');
        };

        // Initialize page
        function init() {
            const params = getURLParams();
            if (params.orderId) {
                log(`Initialized for specific order: ${params.orderId}`, 'info');
                document.querySelector('h1').textContent = `Order Status Manager - Order ${params.orderId}`;
            } else {
                log('Initialized for bulk processing', 'info');
            }
        }

        // Run on page load
        init();
    </script>
</body>
</html>