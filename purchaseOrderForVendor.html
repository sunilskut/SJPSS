<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Orders - Vendor Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #DC2626;
            background-color: #FEE2E2;
            border: 1px solid #FECACA;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-draft { background-color: #FEF3C7; color: #92400E; }
        .status-approved { background-color: #D1FAE5; color: #065F46; }
        .status-sent { background-color: #DBEAFE; color: #1E40AF; }
        .status-confirmed { background-color: #E0E7FF; color: #3730A3; }
        .status-inTransit { background-color: #FDE68A; color: #92400E; }
        .status-delivered { background-color: #A7F3D0; color: #047857; }
        .status-verified { background-color: #BBF7D0; color: #14532D; }
        .status-closed { background-color: #E5E7EB; color: #374151; }
        .status-cancelled { background-color: #FECACA; color: #991B1B; }
        .po-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading State -->
    <div id="loadingState" class="hidden">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="bg-white shadow-xl rounded-lg p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Loading purchase orders...</p>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="bg-white shadow-xl rounded-lg p-8">
                <div class="error-message">
                    <h3 class="font-semibold">Error loading data</h3>
                    <p id="errorMessage"></p>
                    <button id="retryBtn" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Retry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg">
            <div class="max-w-6xl mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-white flex items-center">
                            <i data-lucide="file-text" class="mr-3"></i>
                            Purchase Orders
                        </h1>
                        <p id="vendorInfo" class="text-blue-100 mt-1">Loading vendor information...</p>
                    </div>
                    <div class="text-right text-white">
                        <p class="text-sm opacity-90">Total Orders</p>
                        <p id="totalOrders" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Status</label>
                        <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Statuses</option>
                            <option value="draft">Draft</option>
                            <option value="approved">Approved</option>
                            <option value="sent">Sent</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="inTransit">In Transit</option>
                            <option value="delivered">Delivered</option>
                            <option value="verified">Verified</option>
                            <option value="closed">Closed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sort by</label>
                        <select id="sortFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="amount-desc">Amount (High to Low)</option>
                            <option value="amount-asc">Amount (Low to High)</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search PO</label>
                        <input type="text" id="searchInput" placeholder="Search by PO number..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- Purchase Orders List -->
            <div id="purchaseOrdersList" class="space-y-4">
                <!-- PO cards will be populated here -->
            </div>

            <!-- No Orders Message -->
            <div id="noOrdersMessage" class="hidden text-center py-12">
                <div class="bg-white rounded-lg shadow-md p-8">
                    <i data-lucide="inbox" class="mx-auto h-12 w-12 text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Purchase Orders Found</h3>
                    <p class="text-gray-500">There are no purchase orders matching your criteria.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PO Details Modal -->
    <div id="poDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">Purchase Order Details</h2>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>

                <!-- Modal Content -->
                <div id="modalContent">
                    <!-- Content will be populated dynamically -->
                </div>

                <!-- Modal Actions -->
                <div id="modalActions" class="flex flex-wrap gap-3 pt-6 border-t border-gray-200">
                    <!-- Action buttons will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3iBWleWNMCdQS9F0HR1wHBBtHkeMawhg",
            authDomain: "sjpss-f504b.firebaseapp.com",
            projectId: "sjpss-f504b",
            storageBucket: "sjpss-f504b.firebasestorage.app",
            messagingSenderId: "227402980311",
            appId: "1:227402980311:web:56b580456ab6b9c6758992",
            measurementId: "G-LZ4YP9YPN6"
        };

        // Firebase initialization
        let db = null;
        let vendorId = '';
        let vendorData = null;
        let purchaseOrders = [];
        let filteredOrders = [];

        // Get vendor ID from URL params
        function getVendorIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('vendorId');
        }

        // Initialize Firebase and load data
        function initializeApp() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                vendorId = getVendorIdFromURL();
                if (!vendorId) {
                    showError('Vendor ID not provided in URL. Please access this page with ?vendorId=YOUR_VENDOR_ID');
                    return;
                }
                
                document.getElementById('loadingState').classList.remove('hidden');
                loadData();
            } catch (error) {
                showError('Failed to initialize Firebase: ' + error.message);
            }
        }

        // Load vendor and purchase orders data
        async function loadData() {
            try {
                await Promise.all([loadVendorData(), loadPurchaseOrders()]);
                
                setupEventListeners();
                displayVendorInfo();
                displayPurchaseOrders();
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } catch (error) {
                showError('Failed to load data: ' + error.message);
            }
        }

        // Load vendor data
        async function loadVendorData() {
            try {
                const vendorDoc = await db.collection('vendors').where('vendorId', '==', vendorId).get();
                
                if (vendorDoc.empty) {
                    throw new Error('Vendor not found');
                }
                
                vendorData = { id: vendorDoc.docs[0].id, ...vendorDoc.docs[0].data() };
                console.log('Loaded vendor data:', vendorData);
            } catch (error) {
                console.error('Error loading vendor:', error);
                throw error;
            }
        }

        // Load purchase orders for this vendor
        async function loadPurchaseOrders() {
            try {
                const snapshot = await db.collection('purchaseOrders').get();
                
                purchaseOrders = [];
                snapshot.forEach(doc => {
                    const poData = doc.data();
                    if (poData.vendorId === vendorId) {
                        purchaseOrders.push({
                            id: doc.id,
                            ...poData
                        });
                    }
                });
                
                // Sort by creation date (newest first) by default
                purchaseOrders.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });
                
                filteredOrders = [...purchaseOrders];
                console.log(`Loaded ${purchaseOrders.length} purchase orders for vendor`);
            } catch (error) {
                console.error('Error loading purchase orders:', error);
                throw error;
            }
        }

        // Show error state
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('retryBtn').addEventListener('click', function() {
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('loadingState').classList.remove('hidden');
                loadData();
            });

            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', applyFilters);

            document.getElementById('closeModal').addEventListener('click', closeModal);
            
            // Close modal when clicking outside
            document.getElementById('poDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        // Display vendor information
        function displayVendorInfo() {
            if (!vendorData) return;
            
            document.getElementById('vendorInfo').textContent = `${vendorData.companyName} - ${vendorData.name}`;
            document.getElementById('totalOrders').textContent = purchaseOrders.length;
        }

        // Apply filters and sorting
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Filter by status
            filteredOrders = purchaseOrders.filter(po => {
                if (statusFilter && po.status !== statusFilter) return false;
                if (searchTerm && !po.poId.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            // Sort orders
            filteredOrders.sort((a, b) => {
                switch (sortFilter) {
                    case 'date-asc':
                        const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return dateA - dateB;
                    case 'date-desc':
                        const dateA2 = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const dateB2 = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return dateB2 - dateA2;
                    case 'amount-asc':
                        return (a.totalAmount || 0) - (b.totalAmount || 0);
                    case 'amount-desc':
                        return (b.totalAmount || 0) - (a.totalAmount || 0);
                    default:
                        return 0;
                }
            });

            displayPurchaseOrders();
        }

        // Display purchase orders
        function displayPurchaseOrders() {
            const container = document.getElementById('purchaseOrdersList');
            const noOrdersMessage = document.getElementById('noOrdersMessage');
            
            container.innerHTML = '';
            
            if (filteredOrders.length === 0) {
                container.classList.add('hidden');
                noOrdersMessage.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            noOrdersMessage.classList.add('hidden');

            filteredOrders.forEach(po => {
                const poCard = createPOCard(po);
                container.appendChild(poCard);
            });

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Create PO card element
        function createPOCard(po) {
            const card = document.createElement('div');
            card.className = 'po-card bg-white rounded-lg shadow-md p-6 cursor-pointer transition-all duration-200';
            
            const poDate = po.poDate ? new Date(po.poDate).toLocaleDateString() : 'N/A';
            const expectedDelivery = po.expectedDeliveryDate ? new Date(po.expectedDeliveryDate).toLocaleDateString() : 'N/A';
            const createdAt = po.createdAt ? po.createdAt.toDate().toLocaleDateString() : 'N/A';
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">${po.poId || 'N/A'}</h3>
                        <p class="text-sm text-gray-600">Created: ${createdAt}</p>
                    </div>
                    <span class="status-badge status-${po.status || 'draft'}">${po.status || 'draft'}</span>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <p class="text-sm font-medium text-gray-700">PO Date</p>
                        <p class="text-sm text-gray-900">${poDate}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">Expected Delivery</p>
                        <p class="text-sm text-gray-900">${expectedDelivery}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">Total Items</p>
                        <p class="text-sm text-gray-900">${po.totalQuantity || 0}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">Total Amount</p>
                        <p class="text-lg font-semibold text-blue-600">₹${(po.totalAmount || 0).toFixed(2)}</p>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        ${(po.products || []).length} product(s) • Payment: ${po.paymentStatus || 'unpaid'}
                    </div>
                    <div class="flex items-center text-blue-600">
                        <span class="text-sm mr-1">View Details</span>
                        <i data-lucide="chevron-right" class="h-4 w-4"></i>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => showPODetails(po));
            return card;
        }

        // Show PO details in modal
        function showPODetails(po) {
            document.getElementById('modalTitle').textContent = `Purchase Order: ${po.poId}`;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="space-y-6">
                    <!-- PO Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Order Information</h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">PO Number:</span> ${po.poId || 'N/A'}</p>
                                <p><span class="font-medium">Status:</span> <span class="status-badge status-${po.status || 'draft'}">${po.status || 'draft'}</span></p>
                                <p><span class="font-medium">PO Date:</span> ${po.poDate ? new Date(po.poDate).toLocaleDateString() : 'N/A'}</p>
                                <p><span class="font-medium">Expected Delivery:</span> ${po.expectedDeliveryDate ? new Date(po.expectedDeliveryDate).toLocaleDateString() : 'N/A'}</p>
                                <p><span class="font-medium">Payment Status:</span> ${po.paymentStatus || 'unpaid'}</p>
                                <p><span class="font-medium">Currency:</span> ${po.currency || 'INR'}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Payment & Terms</h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">Payment Terms:</span> ${po.paymentTerms || 'N/A'}</p>
                                <p><span class="font-medium">Remarks:</span> ${po.remarks || 'N/A'}</p>
                                <p><span class="font-medium">Created By:</span> ${po.createdBy || 'N/A'}</p>
                                <p><span class="font-medium">Approved By:</span> ${po.approvedBy || 'N/A'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Products -->
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-3">Products Ordered</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Price</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tax</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${(po.products || []).map(product => `
                                        <tr>
                                            <td class="px-4 py-4 text-sm text-gray-900">${product.name || product.productId || 'N/A'}</td>
                                            <td class="px-4 py-4 text-sm text-gray-900">${product.quantity || 0}</td>
                                            <td class="px-4 py-4 text-sm text-gray-900">₹${(product.unitPrice || 0).toFixed(2)}</td>
                                            <td class="px-4 py-4 text-sm text-gray-900">₹${(product.lineTax || 0).toFixed(2)}</td>
                                            <td class="px-4 py-4 text-sm font-medium text-gray-900">₹${((product.lineTotal || 0) + (product.lineTax || 0)).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-700">Total Quantity:</span>
                                <p class="text-lg font-semibold text-gray-900">${po.totalQuantity || 0}</p>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Subtotal:</span>
                                <p class="text-lg font-semibold text-gray-900">₹${(po.subtotalAmount || 0).toFixed(2)}</p>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Total Tax:</span>
                                <p class="text-lg font-semibold text-gray-900">₹${(po.totalTax || 0).toFixed(2)}</p>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Grand Total:</span>
                                <p class="text-xl font-bold text-blue-600">₹${(po.totalAmount || 0).toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Generate action buttons based on PO status
            const modalActions = document.getElementById('modalActions');
            modalActions.innerHTML = generateActionButtons(po);

            document.getElementById('poDetailsModal').classList.remove('hidden');
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Generate action buttons based on PO status
        function generateActionButtons(po) {
            let buttons = '';
            
            switch (po.status) {
                case 'sent':
                    buttons += `<button onclick="updatePOStatus('${po.id}', 'confirmed')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirm Order</button>`;
                    buttons += `<button onclick="updatePOStatus('${po.id}', 'cancelled')" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Reject Order</button>`;
                    break;
                case 'confirmed':
                    buttons += `<button onclick="updatePOStatus('${po.id}', 'inTransit')" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Mark as In Transit</button>`;
                    break;
                case 'inTransit':
                    buttons += `<button onclick="updatePOStatus('${po.id}', 'delivered')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Mark as Delivered</button>`;
                    break;
                case 'delivered':
                    buttons += `<span class="px-4 py-2 bg-gray-100 text-gray-600 rounded-md">Waiting for Verification</span>`;
                    break;
                case 'verified':
                case 'closed':
                    buttons += `<span class="px-4 py-2 bg-gray-100 text-gray-600 rounded-md">Order Completed</span>`;
                    break;
                case 'cancelled':
                    buttons += `<span class="px-4 py-2 bg-red-100 text-red-600 rounded-md">Order Cancelled</span>`;
                    break;
                default:
                    buttons += `<span class="px-4 py-2 bg-gray-100 text-gray-600 rounded-md">No actions available</span>`;
            }
            
            return buttons;
        }

        // Update PO status
        async function updatePOStatus(poId, newStatus) {
            try {
                await db.collection('purchaseOrders').doc(poId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local data
                const poIndex = purchaseOrders.findIndex(po => po.id === poId);
                if (poIndex !== -1) {
                    purchaseOrders[poIndex].status = newStatus;
                }
                
                // Refresh display
                applyFilters();
                closeModal();
                
                alert(`Purchase Order status updated to: ${newStatus}`);
            } catch (error) {
                console.error('Error updating PO status:', error);
                alert('Error updating status: ' + error.message);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('poDetailsModal').classList.add('hidden');
        }

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeApp();
            }, 100);
        });
    </script>
</body>
</html>